/*
 * PubKey.c
 *
 * Created: 04.10.2021 09:40:37
 *  Author: root
 */ 
#include <stdbool.h>
#include <inttypes.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <avr/eeprom.h>
#include <avr/pgmspace.h>
#include <avr/io.h>
#include <util/atomic.h>
#include <avr/interrupt.h>
#include <string.h>
#include "PubKey.h"
#include "PrivateKey.h"
#include "USART.h"
#include "dstu_types.h"
#include "Field.h"

precomp_set_t PubKeyPreComputedPoints = {
	{
		{ { 3932180761, 4120119491, 3781416468, 3689814887, 2913704939, 3840368239, 834996411, 4012402238, 0 }, { 1030285602, 3542905956, 935414694, 4010459617, 3509733906, 3735431701, 3869358399, 2065411066, 1 } },
		{ { 2945982949, 1938085857, 2721763294, 4026935478, 1649932390, 1066664917, 496488098, 703110996, 0 }, { 793756023, 3926322249, 2198814943, 1833009872, 1641259446, 1867164304, 2201242953, 1839047680, 1 } },
		{ { 1052330346, 3280460905, 3458560093, 1706612173, 1749794023, 1475149975, 3540867387, 1671233435, 0 }, { 2684220060, 2859051426, 1359199145, 2018911506, 3454401357, 3114176357, 3109793310, 1718216180, 1 } },
		{ { 1705697487, 2457320173, 2617000721, 1479086808, 397687366, 3587308930, 1176656624, 3614392389, 1 }, { 2546758576, 3560440988, 2666733050, 4053305669, 2088543387, 826551270, 4277594458, 1355131878, 0 } },
		{ { 182131317, 2431563987, 148789868, 710267051, 2746309027, 2499561211, 1589289111, 3710570536, 0 }, { 1157774658, 1064263639, 3673779814, 4232799379, 3588200150, 1921781938, 2005007925, 3658380885, 0 } },
		{ { 3146071768, 2222287331, 3134336575, 2453148764, 1776057242, 1512379594, 1340195421, 3281629739, 1 }, { 3061970629, 987887305, 897648827, 1965460173, 845277166, 1557181459, 560852902, 1696323287, 1 } },
		{ { 2915744811, 1087468957, 3869627542, 2121140244, 2606200796, 1238298639, 316680667, 3137210859, 0 }, { 1554083259, 248258456, 667832444, 3955408231, 444676981, 3566013656, 1669695680, 2834258363, 0 } },
		{ { 1167889701, 2871510563, 1226876056, 1439206098, 2073420419, 3525927815, 1720140507, 1353590539, 0 }, { 28691323, 3866145726, 933659040, 265916613, 1317510630, 2017069671, 1410364574, 8431467, 0 } }
	},
	{
		{ { 3932180761, 4120119491, 3781416468, 3689814887, 2913704939, 3840368239, 834996411, 4012402238, 0 }, { 3607672891, 649624743, 3600981426, 887413382, 2090455545, 977368186, 3613700484, 2486422980, 1 } },
		{ { 2945982949, 1938085857, 2721763294, 4026935478, 1649932390, 1066664917, 496488098, 703110996, 0 }, { 2161631378, 2575449000, 557158145, 2638719590, 59005392, 1356769605, 2661516267, 1148533588, 1 } },
		{ { 1052330346, 3280460905, 3458560093, 1706612173, 1749794023, 1475149975, 3540867387, 1671233435, 0 }, { 2705636342, 1777235403, 2670119924, 502198495, 2779662250, 4000550898, 1784084261, 99949167, 1 } },
		{ { 1705697487, 2457320173, 2617000721, 1479086808, 397687366, 3587308930, 1176656624, 3614392389, 1 }, { 4066808703, 1179631217, 84893419, 2846989213, 1808309981, 3835024996, 3100947370, 2276125603, 1 } },
		{ { 182131317, 2431563987, 148789868, 710267051, 2746309027, 2499561211, 1589289111, 3710570536, 0 }, { 1339631415, 2944526084, 3525784586, 3592336440, 1986973557, 3866121801, 691756706, 119842429, 0 } },
		{ { 3146071768, 2222287331, 3134336575, 2453148764, 1776057242, 1512379594, 1340195421, 3281629739, 1 }, { 218417181, 3197411114, 2404591236, 3877543569, 1539153012, 116760793, 1854680571, 2793563388, 0 } },
		{ { 2915744811, 1087468957, 3869627542, 2121140244, 2606200796, 1238298639, 316680667, 3137210859, 0 }, { 4050375056, 1310550533, 3245049066, 2511123827, 2178305193, 2638478551, 1902485787, 303124560, 0 } },
		{ { 1167889701, 2871510563, 1226876056, 1439206098, 2073420419, 3525927815, 1720140507, 1353590539, 0 }, { 1143561822, 1297577373, 2122720568, 1511070231, 890404709, 2853399008, 848770629, 1345224800, 0 } }
	}
};

uint32_t PubKeyPointX[9] = { 3932180761, 4120119491, 3781416468, 3689814887, 2913704939, 3840368239, 834996411, 4012402238, 0 };
uint32_t PubKeyPointY[9] = { 3607672891, 649624743, 3600981426, 887413382, 2090455545, 977368186, 3613700484, 2486422980, 1 };
	
bool VerifySignature(uint8_t * hashvalue, uint8_t * signature) {
	field_t SignatureRField;
	field_t SignatureSField;
	field_t hash_v;
	
	field_t r;
	field_t r2;
	
	point_t PubKeypoint;
	point_t mulQ, mulQ2;
	point_t mulS, mulS2;
	point_t PointR;
	
	uint8_t SignatureS[33];
	uint8_t SignatureR[33];
	uint8_t withzero[33];
	
	FieldFromUint32Buf(PubKeyPointX, 9, &PubKeypoint.x);
	FieldFromUint32Buf(PubKeyPointY, 9, &PubKeypoint.y);
	
	SignatureS[0] = 0;
	SignatureR[0] = 0;
	withzero[0] = 0;
	for (int i = 31; i >= 0; i--)
	{
		SignatureR[32 - i] = signature[i];
		SignatureS[32 - i] = signature[i + 32];
		withzero[i + 1] = hashvalue[31 - i];
	}
	
	FieldFromByteArray(withzero, 33, 9, &hash_v);
	FieldFromByteArray(SignatureR, 33, 9, &SignatureRField);
	FieldFromByteArray(SignatureS, 33, 9, &SignatureSField);
	
	PointMulPos_Stage1(&PubKeypoint, &SignatureRField, &mulQ, PubKeyPreComputedPoints);

	PointMulPos_Stage2(&SignatureRField, &mulQ, &mulQ2, PubKeyPreComputedPoints);
	
	PointMulPos_Stage1(&basepoint, &SignatureSField, &mulS, PrivKeyPreComputedPoints);

	PointMulPos_Stage2(&SignatureSField, &mulS, &mulS2, PrivKeyPreComputedPoints);
	
	PointAdd(&mulS2, &mulQ2, &PointR);
	
	FieldMod_Mul(&PointR.x, &hash_v, &r);
	FieldTruncate(&r, &r2);
	
	//PrintDebugUInt32Array(r2.bytes, r2.length, -1);
	//PrintDebugUInt32Array(SignatureRField.bytes, SignatureRField.length, -1);

	return FieldEquals(&r2, &SignatureRField);
}