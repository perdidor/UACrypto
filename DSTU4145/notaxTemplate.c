/*
 * notaxTemplate.c
 *
 * Created: 16.09.2021 09:24:45
 *  Author: root
 */ 
#include "notaxTemplate.h"

#include <math.h>
#include <avr/io.h>
#include <stdio.h>
#include <string.h>
#include <avr/interrupt.h>
#include <avr/eeprom.h>
#include <avr/pgmspace.h>
#include <inttypes.h>
#include <stdlib.h>
#include <stdint.h>

void NoTaxPrepareTemplate(size_t rawDataLength, uint8_t * timestamp, uint8_t * hashvalue, uint8_t * signature) {
	//NoTaxTemplate1_63[45] = (rawDataLength + NoTaxElem3LengthInitValue) & 0xff;
	//NoTaxTemplate1_63[44] = ((rawDataLength + NoTaxElem3LengthInitValue) >> 8) & 0xff;
//
	//NoTaxTemplate1_63[22] = (rawDataLength + NoTaxElem2LengthInitValue) & 0xff;
	//NoTaxTemplate1_63[21] = ((rawDataLength + NoTaxElem2LengthInitValue) >> 8) & 0xff;
//
	//NoTaxTemplate1_63[18] = (rawDataLength + NoTaxElem1LengthInitValue) & 0xff;
	//NoTaxTemplate1_63[17] = ((rawDataLength + NoTaxElem1LengthInitValue) >> 8) & 0xff;
//
	//NoTaxTemplate1_63[3] = (rawDataLength + NoTaxTotalLengthInitValue) & 0xff;
	//NoTaxTemplate1_63[2] = ((rawDataLength + NoTaxTotalLengthInitValue) >> 8) & 0xff;

	//memcpy(&NoTaxTemplate4_81[17], signature, 64);
	//memcpy(&NoTaxTemplate3_30[17], timestamp, 12);
	//memcpy(&NoTaxTemplate2_2458[2426], hashvalue, 32);
}

void NoTaxPrepareDataToSign(uint8_t * hashvalue) {
	memset(DataToSign, 0x00, DataToSignLength);
	memcpy(DataToSign, dtspreamble, 25);
	memcpy(&DataToSign[25], &NoTaxTemplate2_2458[NoTaxTemplate2_certv2offset], 376);
	memcpy(&DataToSign[401], dtspreamble2, 43);
	memcpy(&DataToSign[444], hashvalue, 32);
	memcpy(&DataToSign[476], dtspreamble3, 15);
	memcpy(&DataToSign[491], dts_timestamp, 15);
}

//	add this to unsigned data length and place result as bytes to Template1_63 at pos 2-3 prior sending!!!
const size_t NoTaxTotalLengthInitValue = 2630;

//	add this to unsigned data length and place result as bytes to Template1_63 at pos 17-18 prior sending!!!
const size_t NoTaxElem1LengthInitValue = 2615;

//	add this to unsigned data length and place result as bytes to Template1_63 at pos 21-22 prior sending!!!
const size_t NoTaxElem2LengthInitValue = 2611;

//	add this to unsigned data length and place result as bytes to Template1_63 at pos 44-45 prior sending!!!
const size_t NoTaxElem3LengthInitValue = 19;

const size_t NoTaxTemplate1_SignedDataOffset = 1980;

uint8_t dtspreamble[25] = { 49, 130, 1, 246, 48, 130, 1, 137, 6, 11, 42, 134, 72, 134, 247, 13, 1, 9, 16, 2, 47, 49, 130, 1, 120 };
uint8_t dtspreamble2[43] = { 48, 24, 6, 9, 42, 134, 72, 134, 247, 13, 1, 9, 3, 49, 11, 6, 9, 42, 134, 72, 134, 247, 13, 1, 7, 1, 48, 47, 6, 9, 42, 134, 72, 134, 247, 13, 1, 9, 4, 49, 34, 4, 32 };
uint8_t dtspreamble3[15] = { 48, 28, 6, 9, 42, 134, 72, 134, 247, 13, 1, 9, 5, 49, 15 };
uint8_t dts_timestamp[15] = { 23, 13, 0x32, 0x31, 0x30, 0x39, 0x32, 0x39, 0x31, 0x37, 0x30, 0x31, 0x31, 0x37, 90 };

uint8_t DataToSign[512];
size_t DataToSignLength = 506;
size_t NoTaxTemplate2_certv2offset = 0;

//	must be changed according to unsigned data length before sending out
//	must be followed with unsigned data array
const uint8_t NoTaxTemplate1_63[63] = {
	0x30, 0x82, 0x00, 0x00, 0x06, 0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D,
	0x01, 0x07, 0x02, 0xA0, 0x82, 0x00, 0x00, 0x30, 0x82, 0x00, 0x00, 0x02,
	0x01, 0x01, 0x31, 0x0E, 0x30, 0x0C, 0x06, 0x0A, 0x2A, 0x86, 0x24, 0x02,
	0x01, 0x01, 0x01, 0x01, 0x02, 0x01, 0x30, 0x82, 0x00, 0x00, 0x06, 0x09,
	0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x07, 0x01, 0xA0, 0x82, 0x06,
	0xC7, 0x04, 0x82
};

//	last 32 bytes must be filled with unsigned data gost89 hash byte array[32]
const uint8_t NoTaxTemplate2_2458[451] = {
	0x30, 0x82, 0x01, 0x74, 0x30, 0x82, 0x01, 0x70, 0x30,
	0x82, 0x01, 0x6C, 0x30, 0x0C, 0x06, 0x0A, 0x2A, 0x86, 0x24, 0x02, 0x01,
	0x01, 0x01, 0x01, 0x02, 0x01, 0x04, 0x20, 0x55, 0x85, 0xB3, 0x7C, 0x7A,
	0xB9, 0x1B, 0x9E, 0x37, 0x89, 0xA6, 0x25, 0xFF, 0xC7, 0x7F, 0xFC, 0xCD,
	0xE0, 0xA1, 0xD5, 0x32, 0x8D, 0x1B, 0x70, 0xF6, 0x41, 0x42, 0xBD, 0xF3,
	0x56, 0x58, 0xA3, 0x30, 0x82, 0x01, 0x38, 0x30, 0x82, 0x01, 0x1E, 0xA4,
	0x82, 0x01, 0x1A, 0x30, 0x82, 0x01, 0x16, 0x31, 0x54, 0x30, 0x52, 0x06,
	0x03, 0x55, 0x04, 0x0A, 0x0C, 0x4B, 0xD0, 0x86, 0xD0, 0xBD, 0xD1, 0x84,
	0xD0, 0xBE, 0xD1, 0x80, 0xD0, 0xBC, 0xD0, 0xB0, 0xD1, 0x86, 0xD1, 0x96,
	0xD0, 0xB9, 0xD0, 0xBD, 0xD0, 0xBE, 0x2D, 0xD0, 0xB4, 0xD0, 0xBE, 0xD0,
	0xB2, 0xD1, 0x96, 0xD0, 0xB4, 0xD0, 0xBA, 0xD0, 0xBE, 0xD0, 0xB2, 0xD0,
	0xB8, 0xD0, 0xB9, 0x20, 0xD0, 0xB4, 0xD0, 0xB5, 0xD0, 0xBF, 0xD0, 0xB0,
	0xD1, 0x80, 0xD1, 0x82, 0xD0, 0xB0, 0xD0, 0xBC, 0xD0, 0xB5, 0xD0, 0xBD,
	0xD1, 0x82, 0x20, 0xD0, 0x94, 0xD0, 0x9F, 0xD0, 0xA1, 0x31, 0x5E, 0x30,
	0x5C, 0x06, 0x03, 0x55, 0x04, 0x0B, 0x0C, 0x55, 0xD0, 0xA3, 0xD0, 0xBF,
	0xD1, 0x80, 0xD0, 0xB0, 0xD0, 0xB2, 0xD0, 0xBB, 0xD1, 0x96, 0xD0, 0xBD,
	0xD0, 0xBD, 0xD1, 0x8F, 0x20, 0x28, 0xD1, 0x86, 0xD0, 0xB5, 0xD0, 0xBD,
	0xD1, 0x82, 0xD1, 0x80, 0x29, 0x20, 0xD1, 0x81, 0xD0, 0xB5, 0xD1, 0x80,
	0xD1, 0x82, 0xD0, 0xB8, 0xD1, 0x84, 0xD1, 0x96, 0xD0, 0xBA, 0xD0, 0xB0,
	0xD1, 0x86, 0xD1, 0x96, 0xD1, 0x97, 0x20, 0xD0, 0xBA, 0xD0, 0xBB, 0xD1,
	0x8E, 0xD1, 0x87, 0xD1, 0x96, 0xD0, 0xB2, 0x20, 0xD0, 0x86, 0xD0, 0x94,
	0xD0, 0x94, 0x20, 0xD0, 0x94, 0xD0, 0x9F, 0xD0, 0xA1, 0x31, 0x23, 0x30,
	0x21, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0C, 0x1A, 0xD0, 0x9A, 0xD0, 0x9D,
	0xD0, 0x95, 0xD0, 0x94, 0xD0, 0x9F, 0x20, 0x2D, 0x20, 0xD0, 0x86, 0xD0,
	0x94, 0xD0, 0x94, 0x20, 0xD0, 0x94, 0xD0, 0x9F, 0xD0, 0xA1, 0x31, 0x19,
	0x30, 0x17, 0x06, 0x03, 0x55, 0x04, 0x05, 0x0C, 0x10, 0x55, 0x41, 0x2D,
	0x34, 0x33, 0x31, 0x37, 0x34, 0x37, 0x31, 0x31, 0x2D, 0x32, 0x30, 0x31,
	0x39, 0x31, 0x0B, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02,
	0x55, 0x41, 0x31, 0x11, 0x30, 0x0F, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0C,
	0x08, 0xD0, 0x9A, 0xD0, 0xB8, 0xD1, 0x97, 0xD0, 0xB2, 0x02, 0x14, 0x58,
	0xE2, 0xD9, 0xE7, 0xF9, 0x00, 0x30, 0x7B, 0x04, 0x00, 0x00, 0x00, 0xFE,
	0xAA, 0x25, 0x00, 0x0B, 0xA0, 0x7B, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2A,
	0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x09, 0x03, 0x31, 0x0B, 0x06, 0x09,
	0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x07, 0x01, 0x30, 0x2F, 0x06,
	0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x09, 0x04, 0x31, 0x22,
	0x04, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

//	last 13 bytes must be filled with UTC datetime byte array[y1, y2, M1, M2, d1, d2, h1, h2, m1, m2, s1, s2, 0x5a]
const uint8_t NoTaxTemplate3_30[30] = {
	0x30, 0x1C, 0x06, 0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x09,
	0x05, 0x31, 0x0F, 0x17, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x5A
};

//	last 64 bytes must be filled with DSTU4145 signature byte array[64]
const uint8_t NoTaxTemplate4_81[81] = {
	0x30, 0x0D, 0x06, 0x0B, 0x2A, 0x86, 0x24, 0x02, 0x01, 0x01, 0x01, 0x01,
	0x03, 0x01, 0x01, 0x04, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};